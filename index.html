<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Wallet Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;800&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background: #0a0a0a; color: #facc15; }
        .dreamy-card { background: rgba(250, 204, 21, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(250, 204, 21, 0.2); border-radius: 30px; }
        .gold-btn { background: linear-gradient(135deg, #facc15 0%, #a16207 100%); color: black; font-weight: 800; transition: 0.3s; }
        .gold-btn:hover { transform: scale(1.02); box-shadow: 0 10px 20px rgba(250, 204, 21, 0.2); }
        .notification-bar { background: rgba(250, 204, 21, 0.1); border-bottom: 1px solid rgba(250, 204, 21, 0.3); animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div class="w-full max-w-md flex justify-between p-4 text-[10px] font-bold opacity-70">
        <div class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE</div>
        <div id="live-clock">00:00:00</div>
    </div>

    <div id="notif-area" class="w-full max-w-md hidden">
        <div class="notification-bar m-2 p-3 rounded-2xl flex items-center gap-3">
            <span class="text-xl">ğŸ””</span>
            <div class="text-xs">
                <p class="font-black text-yellow-400">Ù†Û†ØªÛŒÚ©Û•ÛŒØ´Ù†ÛŒ Ù†ÙˆÛ</p>
                <p id="notif-msg" class="text-white opacity-80"></p>
            </div>
        </div>
    </div>

    <div id="auth-ui" class="w-full max-w-md mt-10 p-8 dreamy-card text-center mx-4">
        <h1 class="text-4xl font-black mb-6 text-yellow-400">GOLD WALLET</h1>
        <div id="auth-form" class="space-y-4">
            <input id="email" type="email" placeholder="Ø¦ÛŒÙ…ÛÚµ" class="w-full p-4 bg-white/5 border border-yellow-500/20 rounded-2xl outline-none focus:border-yellow-500">
            <input id="password" type="password" placeholder="Ù¾Ø§Ø³Û†Ø±Ø¯" class="w-full p-4 bg-white/5 border border-yellow-500/20 rounded-2xl outline-none focus:border-yellow-500">
            <div id="signup-fields" class="hidden">
                <input id="display-name" type="text" placeholder="Ù†Ø§ÙˆÛŒ ØªÛ•ÙˆØ§Ùˆ" class="w-full p-4 bg-white/5 border border-yellow-500/20 rounded-2xl mt-4 outline-none">
            </div>
            <button onclick="handleAuth()" id="auth-btn" class="w-full gold-btn py-4 rounded-2xl mt-4">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p onclick="toggleMode()" id="toggle-text" class="text-xs mt-4 opacity-60 cursor-pointer">Ø¦Û•Ú©Ø§ÙˆÙ†ØªÙ… Ù†ÛŒÛŒÛ•ØŸ Ø¯Ø±ÙˆØ³ØªÛŒ Ø¨Ú©Û•</p>
        </div>
    </div>

    <div id="verify-notice" class="w-full max-w-md mt-10 p-8 dreamy-card text-center hidden mx-4">
        <h2 class="text-xl font-bold mb-4">Ø¦ÛŒÙ…ÛÚµÛ•Ú©Û•Øª Ú¤ÛØ±ÛŒÙØ§ÛŒ Ø¨Ú©Û• ğŸ“§</h2>
        <p class="text-sm opacity-70 mb-6">Ù„ÛŒÙ†Ú©ÛŒ Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù† Ø¨Û† Ø¦ÛŒÙ…ÛÚµÛ•Ú©Û•Øª Ù†ÛØ±Ø¯Ø±Ø§ÙˆÛ•. ØªÚ©Ø§ÛŒÛ• Ù¾Ø§Ø´ Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù† Ù„Ø§Ù¾Û•Ú•Û•Ú©Û• Ú•ÛŒÙØ±ÛŒØ´ Ø¨Ú©Û•Ø±Û•ÙˆÛ•.</p>
        <button onclick="location.reload()" class="w-full gold-btn py-3 rounded-xl">Ù¾Ø§Ø´ Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒÚ© Ù„ÛØ±Û• Ø¨Ú©Û•</button>
    </div>

    <div id="main-ui" class="w-full max-w-md hidden p-4">
        <div class="dreamy-card p-8 mb-6 relative overflow-hidden shadow-2xl">
            <p class="text-[10px] uppercase tracking-widest opacity-50">Total Balance</p>
            <h1 id="bal-iqd" class="text-5xl font-black my-2">0 <span class="text-sm font-light">IQD</span></h1>
            <p id="bal-usd" class="text-xl opacity-80 text-white font-mono">$0.00</p>
            
            <div class="mt-8">
                <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden">
                    <div id="prog-bar" class="h-full bg-yellow-400 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p id="prog-txt" class="text-[9px] mt-2 opacity-50">Goal Progress: 0%</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="openModal('income')" class="dreamy-card p-4 hover:bg-yellow-500/10 transition">â• Ø¯Ø§Ù‡Ø§Øª</button>
            <button onclick="openModal('expense')" class="dreamy-card p-4 hover:bg-red-500/10 transition text-red-400">â– Ù…Û•Ø³Ø±Û•Ù</button>
            <button onclick="openModal('transfer')" class="dreamy-card p-4 col-span-2 gold-btn text-black">ğŸ’¸ Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù¾Ø§Ø±Û• Ø¨Û† Ù‡Ø§ÙˆÚ•Û</button>
        </div>

        <div class="dreamy-card p-6 min-h-[300px]">
            <h3 class="font-bold mb-4 border-b border-yellow-500/20 pb-2">Ø³Ø¬Ù„ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú©Ø§Ù†</h3>
            <div id="history" class="space-y-4 max-h-80 overflow-y-auto pr-2"></div>
        </div>
        
        <button onclick="firebase.auth().signOut().then(()=>location.reload())" class="w-full mt-6 text-xs opacity-40">Logout Account</button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-6 z-50">
        <div class="dreamy-card w-full max-w-sm p-8 border-yellow-500/50">
            <h2 id="m-title" class="text-xl font-black mb-6 text-yellow-400"></h2>
            <div id="m-fields" class="space-y-4"></div>
            <div class="flex gap-3 mt-8 text-sm">
                <button onclick="closeModal()" class="flex-1 opacity-50">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                <button id="m-confirm" class="flex-[2] gold-btn py-3 rounded-xl">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMbSkztcgeeNgqpgvKf_VnB9Q4MQKomzk",
            authDomain: "hisabat-5b935.firebaseapp.com",
            databaseURL: "https://hisabat-5b935-default-rtdb.firebaseio.com",
            projectId: "hisabat-5b935",
            storageBucket: "hisabat-5b935.appspot.com",
            appId: "1:925180562302:android:7467c500ade5ab5900c12f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let authMode = 'login';

        // 1. Live Clock
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        // 2. Auth Logic
        function toggleMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            document.getElementById('signup-fields').classList.toggle('hidden', authMode === 'login');
            document.getElementById('auth-btn').innerText = authMode === 'login' ? 'Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•' : 'Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¦Û•Ú©Ø§ÙˆÙ†Øª';
            document.getElementById('toggle-text').innerText = authMode === 'login' ? 'Ø¦Û•Ú©Ø§ÙˆÙ†ØªÙ… Ù†ÛŒÛŒÛ•ØŸ Ø¯Ø±ÙˆØ³ØªÛŒ Ø¨Ú©Û•' : 'Ø¦Û•Ú©Ø§ÙˆÙ†ØªÙ… Ù‡Û•ÛŒÛ•ØŸ Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('display-name').value;
            try {
                if (authMode === 'signup') {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await res.user.sendEmailVerification();
                    await db.ref('users/' + res.user.uid).set({ name: name, balance: 0, email: email });
                    alert("Ù„ÛŒÙ†Ú©ÛŒ Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù† Ø¨Û† Ø¦ÛŒÙ…ÛÚµÛ•Ú©Û•Øª Ù†ÛØ±Ø¯Ø±Ø§ØŒ ØªÚ©Ø§ÛŒÛ• Ú¤ÛØ±ÛŒÙØ§ÛŒ Ø¨Ú©Û•.");
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                if (!user.emailVerified) {
                    document.getElementById('auth-ui').classList.add('hidden');
                    document.getElementById('verify-notice').classList.remove('hidden');
                } else {
                    document.getElementById('auth-ui').classList.add('hidden');
                    document.getElementById('verify-notice').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    loadDashboard(user.uid);
                }
            }
        });

        // 3. Dashboard Logic
        function loadDashboard(uid) {
            db.ref('users/' + uid).on('value', snap => {
                const data = snap.val() || { balance: 0 };
                const bal = data.balance || 0;
                document.getElementById('bal-iqd').innerHTML = bal.toLocaleString() + ' <span class="text-xs opacity-50">IQD</span>';
                document.getElementById('bal-usd').innerText = "$" + (bal / 1520).toFixed(2);
                let prog = (bal / 10000000) * 100;
                document.getElementById('prog-bar').style.width = Math.min(prog, 100) + "%";
                document.getElementById('prog-txt').innerText = `Goal Progress: ${Math.floor(prog)}%`;
            });

            // Notification Listener
            db.ref('users/' + uid + '/history').limitToLast(1).on('child_added', snap => {
                const tx = snap.val();
                if (tx.amount > 0 && (Date.now() - tx.time < 5000)) {
                    document.getElementById('notif-area').classList.remove('hidden');
                    document.getElementById('notif-msg').innerText = `${tx.note} Ø¨Ú•ÛŒ ${tx.amount.toLocaleString()} Ø¨Û†Øª Ù‡Ø§Øª!`;
                    setTimeout(() => document.getElementById('notif-area').classList.add('hidden'), 7000);
                }
            });

            db.ref('users/' + uid + '/history').orderByChild('time').on('value', snap => {
                const list = document.getElementById('history');
                list.innerHTML = "";
                snap.forEach(child => {
                    const tx = child.val();
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border-l-2 ${tx.amount > 0 ? 'border-yellow-400' : 'border-red-500'}">
                            <div><p class="text-sm font-bold">${tx.note}</p><p class="text-[9px] opacity-40">${new Date(tx.time).toLocaleTimeString()}</p></div>
                            <p class="${tx.amount > 0 ? 'text-yellow-400' : 'text-red-400'} font-bold">${tx.amount.toLocaleString()}</p>
                        </div>`;
                });
            });
        }

        // 4. Money Transfer (Fixed & Tested)
        async function transferMoney(targetId, amount) {
            const myUid = auth.currentUser.uid;
            const myEmail = auth.currentUser.email;
            const amt = parseInt(amount);

            const targetSnap = await db.ref('users/' + targetId).get();
            if (!targetSnap.exists()) return alert("Ø¦Û•Ù… Ø¦Ø§ÛŒØ¯ÛŒÛŒÛ• Ø¨ÙˆÙˆÙ†ÛŒ Ù†ÛŒÛŒÛ•!");
            
            // ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û• Ø®Û†Ù…
            await db.ref('users/' + myUid + '/balance').transaction(b => (b || 0) - amt);
            await db.ref('users/' + myUid + '/history').push({ note: `Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù¾Ø§Ø±Û• Ø¨Û† ${targetId.substring(0,5)}`, amount: -amt, time: Date.now() });

            // Ø¯Ø§Ù†Ø§Ù† Ø¨Û† Ø¦Û•Ùˆ
            await db.ref('users/' + targetId + '/balance').transaction(b => (b || 0) + amt);
            await db.ref('users/' + targetId + '/history').push({ note: `Ù¾Ø§Ø±Û• Ù‡Ø§Øª Ù„Û• ${myEmail}`, amount: amt, time: Date.now() });

            alert("Ù¾Ø§Ø±Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù†ÛØ±Ø¯Ø±Ø§!");
            closeModal();
        }

        async function addEntry(type, amt, note) {
            const uid = auth.currentUser.uid;
            const finalAmt = type === 'income' ? parseInt(amt) : -parseInt(amt);
            await db.ref('users/' + uid + '/balance').transaction(b => (b || 0) + finalAmt);
            await db.ref('users/' + uid + '/history').push({ note: note, amount: finalAmt, time: Date.now() });
            closeModal();
        }

        // UI Helpers
        function openModal(mode) {
            const m = document.getElementById('modal');
            const f = document.getElementById('m-fields');
            const btn = document.getElementById('m-confirm');
            m.style.display = 'flex';
            if (mode === 'transfer') {
                document.getElementById('m-title').innerText = "ğŸ’¸ Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù¾Ø§Ø±Û•";
                f.innerHTML = `<input id="v-id" placeholder="ID ÙˆÛ•Ø±Ú¯Ø±" class="w-full p-4 bg-white/10 rounded-2xl outline-none border border-yellow-500/20"><input id="v-amt" type="number" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•" class="w-full p-4 bg-white/10 rounded-2xl border border-yellow-500/20">`;
                btn.onclick = () => transferMoney(document.getElementById('v-id').value, document.getElementById('v-amt').value);
            } else {
                document.getElementById('m-title').innerText = mode === 'income' ? "â• Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§Ù‡Ø§Øª" : "â– ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø®Û•Ø±Ø¬ÛŒ";
                f.innerHTML = `<input id="v-note" placeholder="Ø¨Û†Ú†ÛŒØŸ" class="w-full p-4 bg-white/10 rounded-2xl border border-yellow-500/20"><input id="v-amt" type="number" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•" class="w-full p-4 bg-white/10 rounded-2xl border border-yellow-500/20">`;
                btn.onclick = () => addEntry(mode, document.getElementById('v-amt').value, document.getElementById('v-note').value);
            }
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
    </script>
</body>
</html>
